<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Falling Words</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .drawer {
      position: fixed;
      top: 0;
      right: -230px;
      width: 240px;
      height: 100%;
      background-color: #f9fafb;
      box-shadow: -2px 0 8px rgba(0,0,0,0.1);
      transition: right 0.3s ease-in-out;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .drawer.open {
      right: 0;
    }
    .drawer-toggle {
      position: absolute;
      top: 50%;
      right: 100%;
      transform: translateY(-50%);
      z-index: 1001;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      padding: 1rem 0.5rem;
      border-radius: 8px 0 0 8px;
      font-weight: bold;
      border-right-width: 0;
    }
    .drawer-toggle::before {
      content: '\25c0';
      display: inline-block;
      margin-bottom: 0.5em;
    }
    .drawer.open .drawer-toggle::before {
      content: '\25b6';
    }
    .drawer-content .icon {
      width: 100%;
      justify-content: flex-start;
    }
    .drawer-content {
      padding: 1rem;
      flex-grow: 1;
      overflow-y: auto;
    }
    .drawer-footer {
      padding: 1rem;
      border-top: 1px solid var(--border);
    }
    @media print {
      .drawer, .toolbar {
        display: none;
      }
    }
  </style>
</head>
<body>
<!-- Only one drawer, placed outside the main container -->
<div id="settingsDrawer" class="drawer">
  <button id="drawerToggleBtn" class="icon drawer-toggle">Menu</button>
  <div class="drawer-content">
    <h3>Game Options</h3>
    <div style="margin-bottom:18px;">
      <label style="display:flex;align-items:center;gap:8px;font-weight:bold;">Fall Speed:
        <input type="range" id="fallSpeedSlider" min="1" max="10" value="2" style="flex:1;">
      </label>
    </div>
    <div>
      <label style="display:flex;align-items:center;gap:8px;font-weight:bold;">Word Density:
        <input type="range" id="wordDensitySlider" min="1" max="10" value="5" style="flex:1;">
      </label>
    </div>
  </div>
  <div class="drawer-footer"><a href="../index.html"><button class="icon" style="width: 100%; justify-content: flex-start;">üè† Home</button></a></div>
</div>
<div class="container" style="display: flex; flex-direction: row; gap: 32px; align-items: flex-start;">
  <div style="flex: 1 1 auto; min-width: 0;">
    <div class="toolbar" style="display: flex; align-items: center; justify-content: flex-start; gap: 18px;">
      <div class="badge">Lives: <span id="lives">3</span></div>
      <div class="badge">Score: <span id="score">0</span></div>
      <button id="pauseBtn" class="icon" style="margin-left:auto;">‚è∏Ô∏è Pause</button>
    </div>
    <div style="position:relative;">
      <div id="playfield"></div>
      <div id="startOverlay" style="position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.08);z-index:2;">
        <div class="card"><div class="card-body"><h2>Press any button to begin</h2></div></div>
      </div>
    </div>
    <div class="card" style="margin-top:12px"><div class="card-body">
      <input id="typebox" type="text" placeholder="Type the falling word..." autocomplete="off" spellcheck="false">
      <div class="small">Hit Enter to submit. Words speed up as you score. Missed words cost a life.</div>
    </div></div>
  </div>
  <!-- Drawer is now only outside the container -->
</div>
<script type="module">
  // Drawer logic
  const drawerToggleBtn = document.getElementById("drawerToggleBtn");
  const settingsDrawer = document.getElementById("settingsDrawer");
  if (drawerToggleBtn && settingsDrawer) {
    drawerToggleBtn.addEventListener('click', () => {
      settingsDrawer.classList.toggle('open');
    });
  }
  import { loadConfig, normalizeWord } from "./app.js";

  const cfg = loadConfig();
  if (!cfg) {
    document.body.innerHTML = '<div class="container"><h1>Loading words...</h1></div>';
    // Prevent further script execution until the page reloads with the config.
    throw new Error("Bootstrapping config...");
  }
  const savedSettings = (() => {
    try {
      const raw = localStorage.getItem("wordGamesSettings");
      return raw ? JSON.parse(raw) : null;
    } catch (error) {
      console.warn("Could not parse saved settings for falling words.", error);
      return null;
    }
  })();

  const fallingSettings = savedSettings?.games?.falling || {};
  const legacyWordLength = Number.isInteger(fallingSettings.wordLength) ? fallingSettings.wordLength : null;
  const maxWordLengthSetting = Number.isInteger(fallingSettings.maxWordLength) ? fallingSettings.maxWordLength : (legacyWordLength ?? 6);
  const baseLives = Math.max(1, Math.min(Number(fallingSettings.lives) || 3, 9));
  let baseSpeedSetting = 2;
  let baseGravity = 0.3 + baseSpeedSetting * 0.15;
  let baseSpawnInterval = Math.max(58 - baseSpeedSetting * 3, 40);
  let wordDensity = 5;
  // Drawer logic
  // Drawer logic (already declared above)
  if (typeof drawerToggleBtn !== 'undefined' && typeof settingsDrawer !== 'undefined' && drawerToggleBtn && settingsDrawer) {
    drawerToggleBtn.addEventListener('click', () => {
      settingsDrawer.classList.toggle('open');
    });
  }

  // Fall speed slider logic
  const fallSpeedSlider = document.getElementById('fallSpeedSlider');
  if (fallSpeedSlider) {
    fallSpeedSlider.addEventListener('input', () => {
      baseSpeedSetting = Number(fallSpeedSlider.value);
      baseGravity = 0.3 + baseSpeedSetting * 0.15;
      baseSpawnInterval = Math.max(58 - baseSpeedSetting * 3, 40);
    });
  }

  // Word density slider logic
  const wordDensitySlider = document.getElementById('wordDensitySlider');
  if (wordDensitySlider) {
    wordDensitySlider.addEventListener('input', () => {
      wordDensity = Number(wordDensitySlider.value);
    });
  }
  const maxWordLength = Math.max(3, Math.min(maxWordLengthSetting, 12));

  let vocab = Array.from(new Set(cfg.words.map(normalizeWord))).filter(Boolean);
  const filtered = vocab.filter(word => word.length <= maxWordLength);
  if (filtered.length) {
    vocab = filtered;
  }

  const field = document.getElementById("playfield");
  const box = document.getElementById("typebox");
  const livesEl = document.getElementById("lives");
  const scoreEl = document.getElementById("score");
  const speedEl = document.getElementById("speed");

  let lives = baseLives;
  let score = 0;
  let tick = 0;
  let speedMultiplier = 1;
  let nextId = 1;
  let running = true;
  const active = new Map();

  livesEl.textContent = String(lives);
  speedEl.textContent = formatSpeed(speedMultiplier);

  function formatSpeed(value) {
    return Number.isInteger(value) ? `${value}x` : `${value.toFixed(1)}x`;
  }

  function spawn() {
    const word = vocab[Math.floor(Math.random() * vocab.length)];
    if (!word) {
      return;
    }
    const element = document.createElement("div");
    element.className = "falling-word";
    element.textContent = word;
    const x = Math.max(8, Math.floor(Math.random() * Math.max(field.clientWidth - 80, 40)));
    element.style.left = `${x}px`;
    element.style.top = "-30px";
    const id = nextId++;
    element.dataset.id = String(id);
    field.appendChild(element);
    const velocity = baseGravity + (speedMultiplier - 1) * 0.2 + Math.random() * 0.12;
    active.set(id, { word, el: element, y: -30, speed: velocity });
  }

  function loop() {
    if (!running) {
      return;
    }
    tick++;
    const spawnRate = Math.max(baseSpawnInterval - Math.floor((speedMultiplier - 1) * 8) - Math.floor(score / 4), 22);
    if (tick % spawnRate === 0) {
      spawn();
    }
    for (const [id, obj] of Array.from(active.entries())) {
      obj.y += obj.speed;
      obj.el.style.top = `${obj.y}px`;
      if (obj.y > field.clientHeight - 10) {
        field.removeChild(obj.el);
        active.delete(id);
        lives--;
        livesEl.textContent = String(lives);
        if (lives <= 0) {
          gameOver();
          return;
        }
      }
    }
    requestAnimationFrame(loop);
  }

  function gameOver() {
    running = false;
    const overlay = document.createElement("div");
    overlay.style.position = "absolute";
    overlay.style.inset = "0";
    overlay.style.display = "grid";
    overlay.style.placeItems = "center";
    overlay.style.background = "rgba(0,0,0,.08)";
    overlay.innerHTML = "<div class=\"card\"><div class=\"card-body\"><h2>Game over</h2><p>Score: " + score + "</p><a href=\"falling.html\"><button class=\"primary\">Play again</button></a></div></div>";
    field.appendChild(overlay);
  }

  function handleSubmit() {
    const value = normalizeWord(box.value);
    if (!value) {
      return;
    }
    let targetId = null;
    let bestY = -Infinity;
    for (const [id, obj] of active) {
      if (obj.word === value && obj.y > bestY) {
        targetId = id;
        bestY = obj.y;
      }
    }
    if (targetId !== null) {
      const match = active.get(targetId);
      match.el.remove();
      active.delete(targetId);
      score++;
      scoreEl.textContent = String(score);
      if (score > 0 && score % 6 === 0) {
        speedMultiplier = Math.min(speedMultiplier + 0.3, 1 + baseSpeedSetting * 0.5);
        speedEl.textContent = formatSpeed(speedMultiplier);
      }
      box.value = "";
    } else {
      box.value = "";
    }
  }

  box.addEventListener("keydown", event => {
    if (event.key === "Enter") {
      handleSubmit();
    }
  });

  function fit() {
    field.style.height = "420px";
  }

  fit();

  // Start overlay logic
  const startOverlay = document.getElementById("startOverlay");
  function startGame() {
    if (startOverlay) startOverlay.style.display = "none";
    running = true;
    loop();
    window.removeEventListener("keydown", startGameListener);
    window.removeEventListener("mousedown", startGameListener);
    window.removeEventListener("touchstart", startGameListener);
  }
  function startGameListener() {
    startGame();
  }
  running = false;
  // Only start game if overlay is visible
  if (startOverlay && startOverlay.style.display !== "none") {
    window.addEventListener("keydown", startGameListener);
    window.addEventListener("mousedown", startGameListener);
    window.addEventListener("touchstart", startGameListener);
  }

  // Pause button logic
  const pauseBtn = document.getElementById("pauseBtn");
  if (pauseBtn) {
    pauseBtn.addEventListener("click", () => {
      running = !running;
      pauseBtn.textContent = running ? "‚è∏Ô∏è Pause" : "‚ñ∂Ô∏è Resume";
      if (running) loop();
    });
  }
</script>
</body>
</html>
